<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Voice RAG Assistant Test Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .primary {
            background-color: #007bff;
            color: white;
        }
        .primary:hover {
            background-color: #0056b3;
        }
        .success {
            background-color: #28a745;
            color: white;
        }
        .success:hover {
            background-color: #1e7e34;
        }
        .danger {
            background-color: #dc3545;
            color: white;
        }
        .danger:hover {
            background-color: #c82333;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-entry.info {
            color: #0066cc;
        }
        .log-entry.error {
            color: #cc0000;
        }
        .log-entry.success {
            color: #009900;
        }

    </style>
</head>
<body>
<div class="container">
    <h1>Voice RAG Assistant Test Client</h1>

    <div class="status disconnected" id="status">
        Disconnected
    </div>

    <div class="controls">
        <button class="primary" id="connectBtn" onclick="connect()">Connect</button>
        <button class="danger" disabled id="disconnectBtn" onclick="disconnect()">Disconnect</button>
        <br><br>
        <input id="sessionId" placeholder="Session ID" type="text" value="test_session">
        <br><br>
        <button class="success" disabled id="startAudioBtn" onclick="startAudio()">Start Audio</button>
        <button class="danger" disabled id="stopAudioBtn" onclick="stopAudio()">Stop Audio</button>
    </div>

    <div>
        <h3>Log</h3>
        <div class="log" id="log"></div>
    </div>
</div>

<script>
        let websocket = null;
        let audioContext = null;
        let microphone = null;
        let processor = null;
        let isRecording = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const startAudioBtn = document.getElementById('startAudioBtn');
            
            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                startAudioBtn.disabled = false;
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                startAudioBtn.disabled = true;
                document.getElementById('stopAudioBtn').disabled = true;
            }
        }
        
        function connect() {
            const sessionId = document.getElementById('sessionId').value || 'test_session';
            const wsUrl = `ws://localhost:7860/ws/${sessionId}`;
            
            log(`Connecting to ${wsUrl}...`);
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                log('WebSocket connected successfully', 'success');
                updateStatus(true);
            };
            
            websocket.onmessage = function(event) {
                if (event.data instanceof ArrayBuffer) {
                    log(`Received audio data: ${event.data.byteLength} bytes`, 'info');
                    playAudio(event.data);
                } else {
                    try {
                        const data = JSON.parse(event.data);
                        log(`Received: ${JSON.stringify(data)}`, 'info');
                    } catch (e) {
                        log(`Received raw data: ${event.data}`, 'info');
                    }
                }
            };
            
            websocket.onclose = function(event) {
                log('WebSocket connection closed', 'error');
                updateStatus(false);
                websocket = null;
            };
            
            websocket.onerror = function(error) {
                log(`WebSocket error: ${error}`, 'error');
                updateStatus(false);
            };
        }
        
        function disconnect() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            stopAudio();
            updateStatus(false);
        }
        
        async function startAudio() {
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                log('Audio stream started', 'success');
                
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                
                // Create microphone input
                microphone = audioContext.createMediaStreamSource(stream);
                
                // Create processor for audio data
                processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = function(event) {
                    if (!isRecording || !websocket || websocket.readyState !== WebSocket.OPEN) {
                        return;
                    }
                    
                    const inputBuffer = event.inputBuffer;
                    const channelData = inputBuffer.getChannelData(0);
                    
                    // Convert float32 to int16 PCM
                    const pcmData = new Int16Array(channelData.length);
                    for (let i = 0; i < channelData.length; i++) {
                        // Convert from [-1, 1] to [-32768, 32767]
                        pcmData[i] = Math.max(-32768, Math.min(32767, channelData[i] * 32767));
                    }
                    
                    // Send PCM data as binary
                    websocket.send(pcmData.buffer);
                    log(`Sent PCM audio: ${pcmData.length} samples`, 'success');
                };
                
                // Connect microphone to processor
                microphone.connect(processor);
                processor.connect(audioContext.destination);
                
                isRecording = true;
                
                document.getElementById('startAudioBtn').disabled = true;
                document.getElementById('stopAudioBtn').disabled = false;
                
            } catch (error) {
                log(`Error starting audio: ${error}`, 'error');
            }
        }
        
        function stopAudio() {
            isRecording = false;
            
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            document.getElementById('startAudioBtn').disabled = false;
            document.getElementById('stopAudioBtn').disabled = true;
            
            log('Audio recording stopped', 'info');
        }
        
        function playAudio(audioData) {
            // Create audio context for playback if not exists
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            // Decode and play received audio
            audioContext.decodeAudioData(audioData)
                .then(function(decodedAudio) {
                    const source = audioContext.createBufferSource();
                    source.buffer = decodedAudio;
                    source.connect(audioContext.destination);
                    source.start();
                    log('Playing received audio', 'success');
                })
                .catch(function(error) {
                    log(`Error playing audio: ${error}`, 'error');
                });
        }
        
        // Initialize
        updateStatus(false);
        log('Voice RAG Assistant Test Client initialized');

</script>
</body>
</html> 